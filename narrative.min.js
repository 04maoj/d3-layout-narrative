d3.layout.narrative=function(){function a(){function a(a){var d,e;return d=b.reduce(function(b,c){return a.character===c.character&&b[0]++,a.scene===c.scene&&b[1]++,b},[0,0]),e=d[0]>1&&d[1]>1,c=c&&e,e}var b,c;for(b=[],u.forEach(function(a){a.characters.forEach(function(c){c="object"==typeof c?c:v[c],c._x=c.x||!1,c._y=c.y||!1,c._width=c.width||!1,c._height=c.height||!1,b.push({character:c,scene:a}),a.appearances=[],a.bounds=q,c.appearances=[]}),a._x=a.x||!1,a._y=a.y||!1});!c;)c=!0,b=b.filter(a);v=[],u=[],b.forEach(function(a){a.scene.appearances.push(a),a.character.appearances.push(a),-1===v.indexOf(a.character)&&v.push(a.character),-1===u.indexOf(a.scene)&&u.push(a.scene)})}function b(){function a(a){var b,c,d;for(d=[],b=a.length;b--;)for(c=b;c--;)d.push([v.indexOf(a[b].character),v.indexOf(a[c].character)]);return d}var b,c,d,e;b=v.map(function(a,b){return b}),c=[],u.forEach(function(b){c=c.concat(a(b.appearances))}),c=c.reduce(function(a,b){var c;return c=a.filter(function(a){return!(a.target!==b[0]&&a.target!==b[1]||a.source!==b[0]&&a.source!==b[1])})[0]||{source:b[0],target:b[1],weight:0},c.weight++,1===c.weight&&a.push(c),a},[]),d=s().nodes(b).edges(c)(),D=[],e={},v.forEach(function(a,b){var c,f;c=d[b],f=e[c],f||(f={id:c,characters:[]},D.push(f),e[c]=f),f.characters.push(a),a.group=f})}function c(){u.forEach(function(a){var b,c,d;b=[],c={},a.appearances.forEach(function(a){var d,e;e=D.indexOf(a.character.group),d=c[e],d||(d={groupIndex:e,count:0},c[e]=d,b.push(d)),d.count++}),b.sort(function(a,b){return a.count-b.count}),d=D[b.pop().groupIndex],d.medianCount=d.medianCount||0,d.medianCount++,a.group=d})}function d(){u.forEach(function(a){var b;b=a.appearances.map(function(a){return a.character}),a.group.appearances=a.group.appearances||[],a.group.appearances=a.group.appearances.concat(b.filter(function(b){return-1===a.group.appearances.indexOf(b)}))})}function e(){var a,b,c,d;for(D.sort(function(a,b){return b.medianCount-a.medianCount}),b=[],d=0;D.length;)c=a?D.pop():D.shift(),c.order=d,d++,b.push(c),a=!a;D=b}function f(){var a;a=0,D.forEach(function(b){b.min=a,b.max=a=p(b.appearances.length)+b.min,a+=C})}function g(){v.forEach(function(a){var b,c;b=c=0,a.appearances.forEach(function(a){c++,b+=D.indexOf(a.scene.group)}),a.averageScenePosition=b/c}),D.forEach(function(a){a.characters.sort(function(a,b){var c;return c=a.averageScenePosition-b.averageScenePosition,0!==c?c:v.indexOf(a)-v.indexOf(b)})})}function h(){D.forEach(function(a){a.appearances.sort(function(a,b){var c;return c=a.group.order-b.group.order,0!==c?c:(c=a.averageScenePosition-b.averageScenePosition,0!==c?c:v.indexOf(a)-v.indexOf(b))})})}function i(){var a=1;u.forEach(function(b){b.start=b.start||a,b.duration=b.duration||1,a+=b.duration}),A=(y[0]-B[0])/a}function j(){u.forEach(function(a){a.appearances.sort(function(a,b){var c;return c=a.character.group.order-b.character.group.order,0!==c?c:(c=a.character.averageScenePosition-b.character.averageScenePosition,0!==c?c:v.indexOf(a.character)-v.indexOf(b.character))}),a.appearances.forEach(function(a,b){a.y=o(b),a.x=0})})}function k(){u.forEach(function(a){var b,c,d;a.height=p(a.appearances.length),a.width=0,d=a.appearances.filter(function(b){return b.character.group!==a.group}),d.length||(d=a.appearances),b=d.reduce(function(b,c){return b+=o(a.group.appearances.indexOf(c.character))+a.group.min},0),c=b/d.length,a.y=a._y||c-a.height/2,a.x=a._x||A*a.start+B[0]})}function l(){var a;a=v.map(function(a){return a.appearances[0]}),w=[],a.forEach(function(a){var b,c,d;c=a.scene.x-.5*A,d=a.y+a.scene.y,c-B[0]<B[0]&&(c=B[0]),b={character:a.character,x:a.character._x||c,y:a.character._y||d,width:a.character._width||B[0],height:a.character._height||B[1],bounds:r},a.character.introduction=b,w.push(b)})}function m(){function a(a){var b,c,d,e;return b=d3.min(a,function(a){return a.bounds()[0][0]}),c=d3.max(a,function(a){return a.bounds()[1][0]}),d=d3.min(a,function(a){return a.bounds()[0][1]}),e=d3.max(a,function(a){return a.bounds()[1][1]}),[[b,d],[c,e]]}function b(a){var b,e,f;for(f=[],b=0,e=d.length;e>b;b++)a!==d[b]&&c(a.bounds(),d[b].bounds())&&f.push(d[b]);return f.length?f:!1}function c(a,b){return!(a[1][0]<=b[0][0]||b[1][0]<=a[0][0]||a[1][1]<=b[0][1]||b[1][1]<=a[0][1])}var d,e;d=w.concat(u),e=w.slice(),e.sort(function(a,b){return a.y-b.y}),e.forEach(function(c){function d(a){a.y+=c.bounds()[1][1]-a.bounds()[0][1]}function e(a){return a.character}var f,g,h,i,j,k,l;if(k=b(c),k&&(l=k.filter(function(a){return a.character}),l.forEach(d),k=k.filter(function(a){return!a.character})))for(g=a(k),h=c.bounds(),j=c.y,f=[g[1][1]-h[0][1],g[0][1]-h[1][1]],f.sort(function(a,b){return Math.abs(a)-Math.abs(b)});(i=f.shift())&&(c.y+=i,k=b(c));){if(i>0&&k.every(e)){k.forEach(d);break}c.y=j}})}function n(){x=[],v.forEach(function(a){var b;for(x.push({character:a,source:a.introduction,target:a.appearances[0]}),b=1;b<a.appearances.length;b++)x.push({character:a,source:a.appearances[b-1],target:a.appearances[b]})})}function o(a){return a*z+z/2}function p(a){return o(a)-z/2}function q(){return[[this.x,this.y],[this.x+this.width,this.y+this.height]]}function r(){return[[this.x-this.width,this.y-this.height/2],[this.x,this.y+this.height/2]]}function s(){function a(a){var b={};return a.forEach(function(a){b[a]=!0}),Object.keys(b)}function b(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b}function c(a,b){var c=a._assoc_mat[b]?Object.keys(a._assoc_mat[b]):[],d=0;return c.forEach(function(c){var e=a._assoc_mat[b][c]||1;b===c&&(e*=2),d+=e}),d}function d(a,b){if("undefined"==typeof a._assoc_mat[b])return[];var c=Object.keys(a._assoc_mat[b]);return c}function e(a,b,c){return a._assoc_mat[b]?a._assoc_mat[b][c]:void 0}function f(a){var b=0;return a.edges.forEach(function(a){b+=a.weight}),b}function g(a,b){i(a,b);var c=a.edges.map(function(a){return a.source+"_"+a.target}).indexOf(b.source+"_"+b.target);-1!==c?a.edges[c].weight=b.weight:a.edges.push(b)}function h(a){var b={};return a.forEach(function(a){b[a.source]=b[a.source]||{},b[a.source][a.target]=a.weight,b[a.target]=b[a.target]||{},b[a.target][a.source]=a.weight}),b}function i(a,b){a._assoc_mat[b.source]=a._assoc_mat[b.source]||{},a._assoc_mat[b.source][b.target]=b.weight,a._assoc_mat[b.target]=a._assoc_mat[b.target]||{},a._assoc_mat[b.target][b.source]=b.weight}function j(a){if(null===a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)b[c]=j(a[c]);return b}function k(a,b,g){b.nodes_to_com={},b.total_weight=0,b.internals={},b.degrees={},b.gdegrees={},b.loops={},b.total_weight=f(a),a.nodes.forEach("undefined"==typeof g?function(d,f){b.nodes_to_com[d]=f;var g=c(a,d);if(0>g)throw"Bad graph type, use positive weights!";b.degrees[f]=g,b.gdegrees[d]=g,b.loops[d]=e(a,d,d)||0,b.internals[f]=b.loops[d]}:function(e){var f=g[e];b.nodes_to_com[e]=f;var h=c(a,e);b.degrees[f]=(b.degrees[f]||0)+h,b.gdegrees[e]=h;var i=0,j=d(a,e);j.forEach(function(b){var c=a._assoc_mat[e][b];if(0>=c)throw"Bad graph type, use positive weights";g[b]===f&&(i+=b===e?c:c/2)}),b.internals[f]=(b.internals[f]||0)+i})}function l(c){var d=c.total_weight,e=0,f=a(b(c.nodes_to_com));return f.forEach(function(a){var b=c.internals[a]||0,f=c.degrees[a]||0;d>0&&(e=e+b/d-Math.pow(f/(2*d),2))}),e}function m(a,b,c){var e={},f=d(b,a);return f.forEach(function(d){if(d!==a){var f=b._assoc_mat[a][d]||1,g=c.nodes_to_com[d];e[g]=(e[g]||0)+f}}),e}function n(a,b,c,d){d.nodes_to_com[a]=+b,d.degrees[b]=(d.degrees[b]||0)+(d.gdegrees[a]||0),d.internals[b]=(d.internals[b]||0)+c+(d.loops[a]||0)}function o(a,b,c,d){d.degrees[b]=(d.degrees[b]||0)-(d.gdegrees[a]||0),d.internals[b]=(d.internals[b]||0)-c-(d.loops[a]||0),d.nodes_to_com[a]=-1}function p(a){var b=0,c=j(a),d={},e=Object.keys(a);return e.forEach(function(e){var f=a[e],g="undefined"==typeof d[f]?-1:d[f];-1===g&&(d[f]=b,g=b,b+=1),c[e]=g}),c}function q(a,b){function c(c){var e=b.nodes_to_com[c],f=(b.gdegrees[c]||0)/(2*b.total_weight),g=m(c,a,b);o(c,e,g[e]||0,b);var h=e,i=0,j=Object.keys(g);j.forEach(function(a){var c=g[a]-(b.degrees[a]||0)*f;c>i&&(i=c,h=a)}),n(c,h,g[h]||0,b),h!==e&&(d=!0)}for(var d=!0,e=0,f=l(b),g=f;d&&e!==x&&(f=g,d=!1,e+=1,a.nodes.forEach(c),g=l(b),!(y>g-f)););}function r(c,d){var f,h,i={nodes:[],edges:[],_assoc_mat:{}},j=b(c);return i.nodes=i.nodes.concat(a(j)),d.edges.forEach(function(a){h=a.weight||1;var b=c[a.source],d=c[a.target];f=e(i,b,d)||0;var j=f+h;g(i,{source:b,target:d,weight:j})}),i}function s(a,b){function c(b){var c=b,f=d[b];d[c]=a[e][f]}for(var d=j(a[0]),e=1;b+1>e;e++)Object.keys(d).forEach(c);return d}function t(a,b){if(0===a.edges.length){var c={};return a.nodes.forEach(function(a){c[a]=a}),c}var d={};k(z,d,b);var e=l(d),f=[];q(z,d);var g=l(d),h=p(d.nodes_to_com);f.push(h),e=g;var i=r(h,z);for(k(i,d);;){if(q(i,d),g=l(d),y>g-e)break;h=p(d.nodes_to_com),f.push(h),e=g,i=r(h,i),k(i,d)}return f}var u,v,w,x=-1,y=1e-7,z={},A=function(){var a=t(z,w);return s(a,a.length-1)};return A.nodes=function(a){return arguments.length>0&&(u=a),A},A.edges=function(a){if("undefined"==typeof u)throw"Please provide the graph nodes first!";if(arguments.length>0){v=a;var b=h(a);z={nodes:u,edges:v,_assoc_mat:b}}return A},A.partition_init=function(a){return arguments.length>0&&(w=a),A},A}var t,u,v,w,x,y,z,A,B,C,D;return y=[1,1],A=1,z=10,B=[100,15],C=0,t={},t.scenes=function(a){return arguments.length?(u=a,t):u},t.characters=function(a){return arguments.length?(v=a,t):v},t.size=function(a){return arguments.length?(y=a,t):y},t.characterHeight=function(a){return arguments.length?(z=a,t):z},t.groupMargin=function(a){return arguments.length?(C=a,t):C},t.labelSize=function(a){return arguments.length?(B=a,t):B},t.links=function(){return x},t.link=function(){function a(a){var c,d,e,f,g,h,i;return c=a.source.scene?a.source.scene.x+a.source.x:a.source.x,h=a.source.scene?a.source.scene.y+a.source.y:a.source.y,d=a.target.scene?a.target.scene.x+a.target.x:a.target.x,i=a.target.scene?a.target.scene.y+a.target.y:a.target.y,e=d3.interpolateNumber(c,d),f=e(b),g=e(1-b),"M"+c+","+h+"C"+f+","+h+" "+g+","+i+" "+d+","+i}var b=.5;return a.curvature=function(c){return arguments.length?(b=+c,a):b},a},t.introductions=function(){return w},t.layout=function(){return a(),b(),c(),d(),e(),f(),g(),h(),i(),j(),k(),l(),m(),n(),t},t.relayout=function(){return n(),t},t};